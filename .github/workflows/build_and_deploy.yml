name: Docker

on:
  push:
    branches: [ master ]
  schedule:
    - cron:  '0 3 * * *' # Runs every day at 3AM
  workflow_dispatch: # Allows to manually run this workflow

jobs:
  push_to_registry_and_deploy:
    name: Push Docker image to Docker Hub and deploy to Azure
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      - name: Get the version
        id: get_version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_ENV

      - name: Extract branch name
        shell: bash
        run: echo "BRANCH_NAME=$(echo ${GITHUB_REF##*/})" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Get current date
        id: date
        run: echo "DATE=$(date --utc +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV

      - name: Build and push Docker images
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: fabsau/esn-hd-member:${{ env.VERSION }}, fabsau/esn-hd-member:latest
          labels: version=${{ env.VERSION }}
          build-args: |
            BUILD_VERSION=${{ env.VERSION }}
            VCS_REF=${{ github.sha }}
            BUILD_DATE=${{ env.DATE }}

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure webapp
        run: az webapp config container set --name esn-member --resource-group ESN --docker-custom-image-name fabsau/esn-hd-member:${{ env.VERSION }} --docker-registry-server-url https://hub.docker.com/

      - name: Set environment variables
        run: |
          az webapp config appsettings set --resource-group ESN --name esn-member --settings \
            "BEHIND_PROXY=TRUE" \
            "PORT=3000" \
            "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" \
            "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" \
            "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            "STRIPE_API_KEY=${{ secrets.STRIPE_API_KEY }}" \
            "SUBSCRIPTION_PRICE_ID_MEMBER_6MONTHS=${{ secrets.SUBSCRIPTION_PRICE_ID_MEMBER_6MONTHS }}" \
            "SUBSCRIPTION_PRICE_ID_MEMBER_ANNUALLY=${{ secrets.SUBSCRIPTION_PRICE_ID_MEMBER_ANNUALLY }}" \
            "SUBSCRIPTION_PRICE_ID_ALUMNI_6MONTHS=${{ secrets.SUBSCRIPTION_PRICE_ID_ALUMNI_6MONTHS }}" \
            "SUBSCRIPTION_PRICE_ID_ALUMNI_ANNUALLY=${{ secrets.SUBSCRIPTION_PRICE_ID_ALUMNI_ANNUALLY }}"

      - name: Deploy to Azure
        run: az webapp up --name esn-member --resource-group ESN --plan ESN_Plan

      - name: Set HTTPS only
        run: az webapp update --resource-group ESN --name esn-member --set httpsOnly=true
